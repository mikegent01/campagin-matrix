const NEWS_ARTICLES = {
    headline: [
        {
            id: 'headline_1',
            title: "Archie, The Toad, And The Sorceress: Vigilance Recaptured!",
            image: 'newspaper_xo_defeat.png',
            image_alt: "Chaos in the command center: a powerful female mage looks stunned, her magical staff now held by a small, determined toad-like creature. A centaur and a three-eyed rogue look on.",
            date: "OCTOBER 23, YEAR 42",
            author: "By W.A.H. Media Collective",
            content: `
In a stunning turn of events, the notorious airship _Vigilance_, recently seized by the rogue sorceress X.O., has been dramatically recaptured! Reports from inside the floating fortress confirm a chaotic confrontation involving the enigmatic three-eyed rogue, Archie Miser, the stoic Centaur Paladin, Markop Judi, and surprisingly, a courageous toad identified as Dan.

Sources close to the incident describe a desperate struggle within the _Vigilance_'s command center. The formidable X.O., known for her reality-bending arcane might, was reportedly overwhelmed not by brute force, but by an audacious maneuver orchestrated by the unlikely alliance. Eyewitnesses claim the diminutive toad, Dan, played a pivotal role, disarming the sorceress of her powerful staff at a critical moment, turning the tide of battle.

The recapturing of the _Vigilance_ is a significant blow to X.O.'s mysterious agenda and a major victory for those seeking to restore order, or at least a different kind of chaos. However, questions remain: What were X.O.'s ultimate goals? Where has she vanished to? And what does this unexpected heroism from a mere amphibian mean for the future of the Vigilance? More importantly, who is paying for all this damage? Our sources indicate Waluigi, the renowned Evil Genius, is already filing an insurance claim.
            `,
            type: 'headline'
        }
    ],
    side_story: [
        {
            id: 'side_2',
            title: "Princess Peach Dead: Mushroom Kingdom Plunges into Crisis",
            image: 'falling_figures.png', // Re-purposing an existing asset
            image_alt: "Three figures falling through a colorful, striped sky, one a sorcerer, another cloaked in wolf fur, and a small mushroom-shaped figure. Symbolizes chaos and peril.",
            date: "OCTOBER 25, YEAR 42",
            author: "Crisis Desk Report",
            content: `
In a tragic and shocking development, Princess Peach, beloved ruler of the Mushroom Kingdom, has been confirmed dead. Reports from the fractured kingdom indicate she was killed during a brief but devastating civil conflict, the culmination of years of escalating tensions and frequent incursions by Bowser's Koopa Troop.

While the precise circumstances of her death remain unclear amidst conflicting reports, many within the Protectorate point fingers squarely at Bowser. His relentless campaigns and constant destabilization of the region are widely seen as having created the powder keg that ultimately led to the civil war and the Princess's demise.

The Mushroom Kingdom is now in disarray, with a fractured Regency Council struggling to maintain order. This catastrophic loss marks a grim new chapter for the once-peaceful kingdom, leaving a power vacuum that many fear will only invite further conflict. Our thoughts and prayers are with the Kingdom's lawyers and accountants during this difficult time.
            `,
            type: 'side_story'
        },
        {
            id: 'side_3',
            title: "Archie Acquitted: Mages' Guild Outraged!",
            image: 'newspaper_mage_justice.png',
            image_alt: "A heavy, ornate judge's gavel lies on a stack of ancient, leather-bound law books, with a faint, glowing arcane rune carved into its head.",
            date: "SEPTEMBER 18, YEAR 42",
            author: "Legal Correspondent",
            content: `
In a verdict that has sent shockwaves through the arcane community, the infamous three-eyed rogue, Archie Miser, has been formally acquitted of a mage-killing charge by a tribunal convened by the shadowy Onyx Hand. The decision has been met with fury by the Mages' Guild, who had vigorously pursued charges against Miser.

Guild spokesmages decried the verdict as a "travesty of justice" and a "blatant manipulation" by the Onyx Hand, hinting at deeper, more sinister motives behind the vampire covens' involvement. Archie Miser, whose whereabouts remain largely unknown, has not commented on the verdict, but his newfound freedom is sure to exacerbate tensions between the powerful Guild and the ancient, influential Hand. Legal experts predict a significant increase in demand for legal services specializing in supernatural jurisprudence.
            `,
            type: 'side_story'
        },
        {
            id: 'side_4',
            title: "Iron Fists Busted: Smuggling Ring Crushed!",
            image: 'newspaper_iron_fists_bust.png',
            image_alt: "A smashed wooden crate with the Iron Fists logo stenciled on the side, glowing vials and contraband artifacts spilled onto cobblestones.",
            date: "SEPTEMBER 25, YEAR 42",
            author: "Underworld Beat",
            content: `
A major smuggling operation controlled by the ruthless Iron Fists gang has been dramatically dismantled, leaving their illicit network in disarray. Sources within the underworld point to the same loose band of adventurers, including the notorious Archie Miser and Markop Judi, as responsible for the high-impact raid.

The bust reportedly resulted in significant losses for the Iron Fists, with valuable contraband seized and distribution channels disrupted. While law enforcement agencies have remained tight-lipped, the criminal underworld is abuzz with theories about who commissioned the hit. The Iron Fists have reportedly placed a hefty bounty on the heads of those responsible, promising swift and brutal retribution. This disruption is expected to cause a temporary spike in the street price of glowing vials and mysterious artifacts.
            `,
            type: 'side_story'
        },
        {
            id: 'side_5',
            title: "Centaur Saves Goblin: Unlikely Alliance Forged?",
            image: 'newspaper_airship.png',
            image_alt: "A majestic, sleek, sleek, magitek airship disappearing into dark, swirling storm clouds.",
            date: "OCTOBER 24, YEAR 42",
            author: "By The Watcher",
            content: `
In a bizarre twist amidst the recent Orc uprising on the _Vigilance_, the Centaur Paladin, Markop Judi, was observed intervening to save the life of Lario, a prominent Goblin mechanic and workshop owner. Judi, whose own reputation has been tarnished by association with unsavory elements, reportedly warned Lario of an impending Orcish sneak attack, allowing the Goblin to escape certain capture or worse.

This unlikely act of chivalry between a disciplined Paladin and a pragmatic Goblin has raised eyebrows. Is it a sign of a burgeoning alliance, or simply a momentary lapse in hostilities during a shared crisis? Lario, known for his questionable business practices, has remained silent, but the incident has sparked whispers across the airwaves. Local bookmakers are already taking bets on how long this fragile truce will last.
            `,
            type: 'side_story'
        },
        {
            id: 'side_6',
            title: "Dragon Slain! Heroes Achieve Legendary Feat",
            image: 'newspaper_dragon_defeat.png',
            image_alt: "A massive, dead dragon lies slumped against a mountain peak. Two small, heroic figures stand victoriously in the foreground.",
            date: "SEPTEMBER 10, YEAR 42",
            author: "Epic Chronicle Team",
            content: `
The northern mountains, long plagued by the terrifying dragon Ignis, are now safe. Reports confirm that a group of intrepid adventurers, including Archie Miser and Markop Judi, successfully hunted down and slew the fearsome beast in a climactic battle.

This legendary feat has been met with widespread celebration by the Iron Legion, who view the dragon's eradication as a strategic victory. However, the Mages' Guild has expressed strong condemnation, stating that the uncontrolled use of power in such a volatile manner sets a dangerous precedent and disrespects arcane traditions. Regardless of magical ethics, the heroes' names are now sung in taverns, and Ignis's hoard is reportedly up for grabs.
            `,
            type: 'side_story'
        },
        {
            id: 'side_7',
            title: "Shadow War Rages: Vampires and Werewolves Clash",
            image: 'newspaper_shadow_war.png',
            image_alt: "A shadowy city street at night, where the silhouettes of a snarling werewolf clashes with the elegant, caped silhouette of a vampire. Gothic architecture looms in the background.",
            date: "OCTOBER 15, YEAR 42",
            author: "Occult Affairs Desk",
            content: `
The ancient, clandestine conflict between the Onyx Hand (vampires) and the Moonfang Pack (werewolves) in the city's underbelly has erupted into open skirmishes. Reports suggest that a certain chaotic element, perhaps the same adventurers recently involved in the _Vigilance_ incident, are inadvertently, or perhaps deliberately, fanning the flames of this shadow war.

Clandestine sources confirm multiple bloody encounters across the city's gothic districts, with both factions suffering significant losses. The Order of the Silver Flame, staunch enemies of both supernatural groups, has condemned the escalation, warning of widespread collateral damage to the mortal populace. The streets are becoming increasingly dangerous after dark, and Waluigi Enterprises is offering a special discount on reinforced doors and silver-plated fangs.
            `,
            type: 'side_story'
        },
        {
            id: 'side_8',
            title: "Wario's Ghost Escapes! Barrel Trouble on the Vigilance",
            image: 'logo.png', // Using Waluigi's logo for Wario related news for thematic consistency
            image_alt: "Waluigi's stylized purple L logo.",
            date: "OCTOBER 22, YEAR 42",
            author: "Paranormal Investigator",
            content: `
Panic briefly erupted in Cargo Bay 3 of the _Vigilance_ yesterday when the spectral form of Wario, formerly Waluigi's partner and now a notorious ghost, reportedly made a daring escape. Eyewitnesses claim Wario, still clinging to a barrel, phased through the bulkhead, disappearing into the chaotic dimensional currents surrounding the airship.

It is rumored that Wario, ever the opportunist, is now seeking to reassemble his infamous Goldgrubber Gang, known for their insatiable greed and penchant for shiny objects. This development adds another unpredictable element to the already volatile situation surrounding the _Vigilance_. Waluigi, when reached for comment, merely cackled and muttered something about "loose ends" and "property damage liability."
            `,
            type: 'side_story'
        },
        {
            id: 'side_9',
            title: "Bowser's Alliance: Warlord Joins Party, Troops Mobilize",
            image: 'humpik.png', // Placeholder, using Humpik image if available. Otherwise, no image for this one, as I don't have a specific Bowser one.
            image_alt: "The imposing figure of Humpik.",
            date: "OCTOBER 23, YEAR 42",
            author: "Military Analyst",
            content: `
In a move that has stunned political observers, the fearsome warlord Bowser, recently a captive on the _Vigilance_, has reportedly formed an alliance with the very party that secured the airship. This alliance was short-lived, as Bowser has now departed to deal with the fallout from Princess Peach's death, but his Koopa Troop remains a powerful, independent force. The ramifications of this temporary alliance are still unfolding.
            `,
            type: 'side_story'
        },
        {
            id: 'side_10',
            title: "Big T's Legacy: Whereabouts Unknown, Sword Recovered",
            image: 'faction_toad_gang.png',
            image_alt: "A graffiti-style, angry-eyed mushroom skull, possibly with a crown askew.",
            date: "OCTOBER 24, YEAR 42",
            author: "Underground Reporter",
            content: `
The mysterious disappearance of Big T, the tyrannical leader of the Toad Gang, from the _Vigilance_ continues to baffle authorities. While his body remains unaccounted for, his signature sword was reportedly recovered during investigations. This strange development has fueled rampant speculation of his potential revival.

Whispers among the Toad Gang's various factions suggest a power struggle for control in Big T's absence. Some loyalists believe he will return to reclaim his throne, while the more radical Mushroom Skulls see his defeat as an opportunity to seize power and escalate the 'Toadification' campaign. The Freelancer Underworld, ever opportunistic, is already betting on who will emerge victorious from the ensuing chaos. The only certainty is uncertainty, and a very valuable sword that Waluigi has probably already pawned.
            `,
            type: 'side_story'
        }
    ],
    waluigi_corner: [
        {
            id: 'waluigi_1',
            title: "Waluigi's World Domination Tip #42!",
            content: `
WAH! You think you've seen chaos? You haven't seen anything until *I* get involved! All these little squabbles, these "factions," they're just puppets on my strings! The trick is to find what makes them tick, then **PULL THE STRING!**

The Empire? So stiff! Just give their engineers a *new* toy, one that's slightly unstable, and watch the sparks fly! The Mages' Guild? Full of bookworms. Just introduce them to something they can't *classify*, something truly **PARADOXICAL**, and they'll tear each other apart trying to understand it! And those whiny rebels? Give 'em a "common enemy" that's *actually* on your side, and boom! Instant distraction!

Remember, peace is boring. **CHAOS** is profitable! And nobody does chaos better than your favorite Evil Genius, Waluigi! WAH HA HA!
            `,
            type: 'waluigi_corner'
        }
    ],
    advert: [
        {
            id: 'advert_1',
            title: "Reliable Barrel Transport!",
            image: 'wario.png', // Assuming Wario asset will be created soon, or a barrel.
            image_alt: "A sturdy wooden barrel.",
            content: "Need to make a quick getaway? Or perhaps transport a valuable (or ghostly) cargo? **Bongo's Barrels** offers discreet and surprisingly sturdy barrel-based transport solutions. Fast, reliable, and almost impossible to track! (Not responsible for dimensional shifts or accidental resurrections.)",
            cta: "Call Now!",
            type: 'advert'
        },
        {
            id: 'advert_2',
            title: "Need a new Staff? Or two?",
            image: 'staff.png', // Assuming a staff asset will be created or used
            image_alt: "A gleaming magical staff.",
            content: "Lost your powerful arcane artifact in a scuffle? **Lario's Workshop** has a wide selection of ethically sourced (mostly) magical staves, wands, and other pointy bits! Trade-ins welcome, no questions asked. Special discounts for 'liberated' magical items!",
            cta: "Visit Lario's!",
            type: 'advert'
        },
        {
            id: 'advert_3',
            title: "Secure Your Secrets! (or steal others')",
            image: 'icon_dossier.png',
            image_alt: "An open folder icon.",
            content: "**The Shadowbrokers' Guild** offers top-tier information gathering and protection services. From secure data vaults to discreet asset acquisition, we ensure your secrets are safe... or that your enemies' secrets are not. Blackmail and counter-espionage a specialty.",
            cta: "Inquire Within",
            type: 'advert'
        },
        {
            id: 'advert_4',
            title: "Don't Be a Victim! Hire The Iron Fists!",
            image: 'faction_iron_fists.png',
            image_alt: "Iron Fists faction logo.",
            content: "Trouble with rivals? Need a 'package' delivered discreetly? **The Iron Fists** offer comprehensive protection and enforcement services. We'll make sure your 'competitors' understand who's boss. Discreet, effective, and always gets the job done. (Payment upfront.)",
            cta: "Contact Us",
            type: 'advert'
        }
    ]
};

// --- AUDIO ---
let audioContext;
const audioBuffers = {};

function initAudio() {
    if (audioContext) return;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        loadSound('click.mp3');
    } catch (e) {
        console.warn('Web Audio API is not supported in this browser');
    }
}

async function loadSound(url) {
    if (!audioContext || audioBuffers[url]) return;
    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = buffer;
    } catch (e) {
        console.error(`Failed to load sound: ${url}`, e);
    }
}

function playSound(url, volume = 0.7) {
    if (!audioContext || !audioBuffers[url]) {
        return;
    }
    const source = audioContext.createBufferSource();
    source.buffer = audioBuffers[url];
    const gainNode = audioContext.createGain();
    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    source.connect(gainNode).connect(audioContext.destination);
    source.start(0);
}

// --- RENDERING ---

function getTodaysDate() {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date().toLocaleDateString('en-US', options).toUpperCase();
}

function renderArticle(article, container) {
    if (!container) return;

    let contentHTML = marked.parse(article.content || '');

    const articleClass = article.type === 'waluigi_corner' ? 'waluigi-corner' : (article.type === 'headline' ? 'headline' : '');
    
    container.className = `news-article ${articleClass}`;
    container.innerHTML = `
        <h3>${article.title}</h3>
        ${article.author ? `<div class="article-meta"><span>${article.date}</span> | <span>${article.author}</span></div>` : ''}
        ${article.image ? `<figure><img src="${article.image}" alt="${article.image_alt || article.title}"><figcaption>${article.image_alt || article.title}</figcaption></figure>` : ''}
        <div class="article-content">${contentHTML}</div>
    `;
}

function renderSideStory(article, container) {
    if (!container) return;

    const articleElement = document.createElement('div');
    articleElement.className = 'news-article';

    const contentHTML = marked.parse(article.content || '');

    articleElement.innerHTML = `
        <h3>${article.title}</h3>
        <div class="article-meta">
            <span>${article.date}</span> | <span>${article.author}</span>
        </div>
        ${article.image ? `<figure><img src="${article.image}" alt="${article.image_alt || article.title}"><figcaption>${article.image_alt || article.title}</figcaption></figure>` : ''}
        <div class="article-content">${contentHTML}</div>
    `;
    container.appendChild(articleElement);
}

function renderAdvert(advert, container) {
    if (!container) return;

    const advertElement = document.createElement('div');
    advertElement.className = 'advert-block';

    advertElement.innerHTML = `
        <h4>Advertisement</h4>
        ${advert.image ? `<img src="${advert.image}" alt="${advert.image_alt || advert.title}">` : ''}
        <h5>${advert.title}</h5>
        <p>${advert.content}</p>
        <a href="#" class="advert-cta">${advert.cta}</a>
    `;
    container.appendChild(advertElement);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function renderNewspaper() {
    document.getElementById('newspaper-date').textContent = getTodaysDate();

    const headlineContainer = document.getElementById('headline-article');
    const sideStoriesContainer = document.getElementById('side-stories-container');
    const waluigiContainer = document.getElementById('waluigi-corner');
    const advertsContainer = document.getElementById('adverts-container');
    
    // Render Headline
    const headlineArticle = NEWS_ARTICLES.headline[0];
    if (headlineArticle) {
        renderArticle(headlineArticle, headlineContainer);
    }

    // Render Side Stories
    if (sideStoriesContainer) {
        sideStoriesContainer.innerHTML = ''; // Clear previous
        const shuffledSideStories = shuffleArray([...NEWS_ARTICLES.side_story]);
        const numberOfSideStories = Math.min(shuffledSideStories.length, 4); 
        for (let i = 0; i < numberOfSideStories; i++) {
            renderSideStory(shuffledSideStories[i], sideStoriesContainer);
        }
    }

    // Render Waluigi's Corner
    const waluigiCornerArticle = NEWS_ARTICLES.waluigi_corner[0];
    if (waluigiCornerArticle) {
        renderArticle(waluigiCornerArticle, waluigiContainer);
    }

    // Render Adverts
    if (advertsContainer) {
        advertsContainer.innerHTML = ''; // Clear previous
        const shuffledAdverts = shuffleArray([...NEWS_ARTICLES.advert]);
        const numberOfAdverts = Math.min(shuffledAdverts.length, 4); 
        for (let i = 0; i < numberOfAdverts; i++) {
            renderAdvert(shuffledAdverts[i], advertsContainer);
        }
    }
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    document.body.addEventListener('click', () => initAudio(), { once: true });

    document.getElementById('adverts-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('advert-cta')) {
            e.preventDefault();
            playSound('click.mp3', 0.6);
            alert("WAH! You clicked an ad! Now go buy Waluigi's goods!");
        }
    });
}

// --- INITIALIZATION ---
function main() {
    renderNewspaper();
    setupEventListeners();
}

main();